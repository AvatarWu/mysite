/**
 * æ•¸æ“šåŒæ­¥åŠŸèƒ½æ¸¬è©¦è…³æœ¬
 * åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­é‹è¡Œæ­¤è…³æœ¬ä¾†æ¸¬è©¦åŒæ­¥åŠŸèƒ½
 */

// æ“´å±• Window æ¥å£ä»¥åŒ…å«æˆ‘å€‘çš„æœå‹™
declare global {
  interface Window {
    dataSyncService: any;
    healthDataService: any;
  }
}

// æ¸¬è©¦æ•¸æ“š
const testWeightRecord = {
  weight: 70.5,
  height: 170,
  bmi: 24.4,
  note: 'æ¸¬è©¦è¨˜éŒ„',
  date: new Date().toISOString().split('T')[0]
};

// æ¸¬è©¦å‡½æ•¸
export const runSyncTests = async () => {
  console.log('ğŸš€ é–‹å§‹é‹è¡Œæ•¸æ“šåŒæ­¥æ¸¬è©¦...');
  
  try {
    // æ¸¬è©¦ 1: æª¢æŸ¥æœå‹™æ˜¯å¦å¯ç”¨
    console.log('\nğŸ“‹ æ¸¬è©¦ 1: æª¢æŸ¥æœå‹™å¯ç”¨æ€§');
    if (typeof window !== 'undefined' && window.dataSyncService) {
      console.log('âœ… æ•¸æ“šåŒæ­¥æœå‹™å¯ç”¨');
    } else {
      console.log('âŒ æ•¸æ“šåŒæ­¥æœå‹™ä¸å¯ç”¨');
      return;
    }

    // æ¸¬è©¦ 2: æ·»åŠ é«”é‡è¨˜éŒ„
    console.log('\nğŸ“‹ æ¸¬è©¦ 2: æ·»åŠ é«”é‡è¨˜éŒ„');
    try {
      const newRecord = await window.healthDataService.addWeightRecord(testWeightRecord);
      console.log('âœ… é«”é‡è¨˜éŒ„æ·»åŠ æˆåŠŸ:', newRecord);
    } catch (error) {
      console.log('âŒ é«”é‡è¨˜éŒ„æ·»åŠ å¤±æ•—:', error);
    }

    // æ¸¬è©¦ 3: æª¢æŸ¥åŒæ­¥ç‹€æ…‹
    console.log('\nğŸ“‹ æ¸¬è©¦ 3: æª¢æŸ¥åŒæ­¥ç‹€æ…‹');
    const syncStats = window.dataSyncService.getSyncStats();
    console.log('åŒæ­¥ç‹€æ…‹:', syncStats);
    console.log('å¾…åŒæ­¥è®Šæ›´æ•¸é‡:', window.dataSyncService.getPendingChangesCount());

    // æ¸¬è©¦ 4: æ‰‹å‹•åŒæ­¥
    console.log('\nğŸ“‹ æ¸¬è©¦ 4: æ‰‹å‹•åŒæ­¥');
    try {
      const syncResult = await window.dataSyncService.manualSync();
      console.log('âœ… æ‰‹å‹•åŒæ­¥å®Œæˆ:', syncResult);
    } catch (error) {
      console.log('âŒ æ‰‹å‹•åŒæ­¥å¤±æ•—:', error);
    }

    // æ¸¬è©¦ 5: æª¢æŸ¥æœ¬åœ°å­˜å„²
    console.log('\nğŸ“‹ æ¸¬è©¦ 5: æª¢æŸ¥æœ¬åœ°å­˜å„²');
    const localData = localStorage.getItem('weightRecords');
    if (localData) {
      const records = JSON.parse(localData);
      console.log('æœ¬åœ°é«”é‡è¨˜éŒ„æ•¸é‡:', records.length);
      console.log('æœ€æ–°è¨˜éŒ„:', records[0]);
    } else {
      console.log('âŒ æœ¬åœ°æ²’æœ‰é«”é‡è¨˜éŒ„');
    }

    // æ¸¬è©¦ 6: æª¢æŸ¥å¾…åŒæ­¥è®Šæ›´
    console.log('\nğŸ“‹ æ¸¬è©¦ 6: æª¢æŸ¥å¾…åŒæ­¥è®Šæ›´');
    const pendingCount = window.dataSyncService.getPendingChangesCount();
    console.log('å¾…åŒæ­¥è®Šæ›´æ•¸é‡:', pendingCount);

    // æ¸¬è©¦ 7: ç¶²çµ¡ç‹€æ…‹æ¨¡æ“¬
    console.log('\nğŸ“‹ æ¸¬è©¦ 7: ç¶²çµ¡ç‹€æ…‹æ¨¡æ“¬');
    console.log('ç•¶å‰ç¶²çµ¡ç‹€æ…‹:', window.dataSyncService.getSyncStatus());

    console.log('\nğŸ‰ æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼');
    
  } catch (error) {
    console.error('âŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
  }
};

// æ¸…ç†æ¸¬è©¦æ•¸æ“š
export const cleanupTestData = async () => {
  console.log('ğŸ§¹ æ¸…ç†æ¸¬è©¦æ•¸æ“š...');
  
  try {
    await window.healthDataService.clearAllLocalData();
    console.log('âœ… æ¸¬è©¦æ•¸æ“šæ¸…ç†å®Œæˆ');
  } catch (error) {
    console.log('âŒ æ¸…ç†æ¸¬è©¦æ•¸æ“šå¤±æ•—:', error);
  }
};

// æ€§èƒ½æ¸¬è©¦
export const runPerformanceTest = async () => {
  console.log('âš¡ é–‹å§‹æ€§èƒ½æ¸¬è©¦...');
  
  const startTime = performance.now();
  
  try {
    // æ‰¹é‡æ·»åŠ è¨˜éŒ„
    const promises = [];
    for (let i = 0; i < 10; i++) {
      const record = {
        ...testWeightRecord,
        weight: 70 + Math.random() * 2,
        note: `æ€§èƒ½æ¸¬è©¦è¨˜éŒ„ ${i + 1}`
      };
      promises.push(window.healthDataService.addWeightRecord(record));
    }
    
    await Promise.all(promises);
    
    const endTime = performance.now();
    const duration = endTime - startTime;
    
    console.log(`âœ… æ‰¹é‡æ·»åŠ  10 æ¢è¨˜éŒ„å®Œæˆï¼Œè€—æ™‚: ${duration.toFixed(2)}ms`);
    console.log(`å¹³å‡æ¯æ¢è¨˜éŒ„: ${(duration / 10).toFixed(2)}ms`);
    
  } catch (error) {
    console.log('âŒ æ€§èƒ½æ¸¬è©¦å¤±æ•—:', error);
  }
};

// å°‡æ¸¬è©¦å‡½æ•¸æ·»åŠ åˆ°å…¨å±€å°è±¡
if (typeof window !== 'undefined') {
  (window as any).runSyncTests = runSyncTests;
  (window as any).cleanupTestData = cleanupTestData;
  (window as any).runPerformanceTest = runPerformanceTest;
  
  console.log('ğŸ”§ æ¸¬è©¦å‡½æ•¸å·²æ·»åŠ åˆ°å…¨å±€å°è±¡:');
  console.log('- window.runSyncTests() - é‹è¡ŒåŒæ­¥æ¸¬è©¦');
  console.log('- window.cleanupTestData() - æ¸…ç†æ¸¬è©¦æ•¸æ“š');
  console.log('- window.runPerformanceTest() - é‹è¡Œæ€§èƒ½æ¸¬è©¦');
}

// è‡ªå‹•é‹è¡Œæ¸¬è©¦ï¼ˆå¯é¸ï¼‰
if (process.env.NODE_ENV === 'development') {
  console.log('ğŸ”„ é–‹ç™¼ç’°å¢ƒæª¢æ¸¬åˆ°ï¼Œæº–å‚™è‡ªå‹•é‹è¡Œæ¸¬è©¦...');
  // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿æœå‹™å·²åˆå§‹åŒ–
  setTimeout(() => {
    runSyncTests();
  }, 2000);
}
